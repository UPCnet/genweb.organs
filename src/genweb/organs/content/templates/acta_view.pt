<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ca"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="ca"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="genweb.organs">
<body>

<div metal:fill-slot="main" tal:condition="view/canView"
     tal:define="membresConvocats context/membresConvocats;
                 membresConvidats context/membresConvidats;
                 llistaExcusats context/llistaExcusats;
                 llistaNoAssistens context/llistaNoAssistens;
                 assistents context/assistents;
                 ordenDelDia context/ordenDelDia;
                 llocConvocatoria context/llocConvocatoria;
                 horaFi view/horaFi;
                 horaInici view/horaInici;
                 audio view/AudioInside;
                 annexes view/AnnexInside;
                 enllacVideo context/enllacVideo;
                 absolute_url context/absolute_url;
                 hasFirma view/hasFirma;
                 checkSerieGDoc view/checkSerieGDoc;">

  <div class="container my-4">
    <!-- Barra d'accions -->
    <div class="d-flex justify-content-end mb-3 gap-2">
      <a id="printActaBtn" class="btn btn-outline-secondary btn-sm" tal:condition="view/viewPrintButon" href="#">
        <i class="bi bi-printer"></i> <span i18n:translate="">Imprimir</span>
      </a>
      <iframe id="printActaIframe" name="printActaIframe" style="display:none;width:0;height:0;border:0;" src=""></iframe>
      <a id="previewActaBtn" class="btn btn-outline-secondary btn-sm" tal:condition="view/viewPrintButon" tal:attributes="data-url string:${absolute_url}/previewActa" href="#">
        <i class="bi bi-eye"></i> <span i18n:translate="">Previsualitza</span>
      </a>
    </div>

    <!-- Estat firma -->
    <div tal:condition="hasFirma" class="mb-3">
      <span tal:define="estat view/estatFirma" tal:attributes="class string:badge rounded-pill bg-primary">Acta: <tal:replace="estat/text"/></span>
    </div>

    <!-- Pestanyes Bootstrap 5 -->
    <ul class="nav nav-tabs" id="actaTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="dades-tab" data-bs-toggle="tab" data-bs-target="#dades" type="button" role="tab">Dades</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="assistents-tab" data-bs-toggle="tab" data-bs-target="#assistents" type="button" role="tab">Assistents</button>
      </li>
    </ul>
    <div class="tab-content border border-top-0 p-3" id="actaTabContent">
      <!-- Dades -->
      <div class="tab-pane fade show active" id="dades" role="tabpanel" aria-labelledby="dades-tab">
        <ul class="list-unstyled">
          <li tal:condition="horaInici"><strong i18n:translate="">Inici:</strong> <span tal:content="horaInici" /></li>
          <li tal:condition="horaFi"><strong i18n:translate="">Fi:</strong> <span tal:content="horaFi" /></li>
          <li tal:condition="llocConvocatoria"><strong i18n:translate="">Lloc:</strong> <span tal:content="llocConvocatoria" /></li>
          <li tal:condition="enllacVideo"><strong i18n:translate="">Vídeo:</strong> <a tal:attributes="href enllacVideo; target string:_blank">link</a></li>
        </ul>

        <!-- Audios -->
        <div tal:condition="audio">
          <h5 class="mt-3" i18n:translate="">Àudios</h5>
          <ul class="list-unstyled">
            <tal:repeat repeat="item audio">
              <li class="mb-2">
                <i class="bi bi-file-earmark-music"></i>
                <a tal:attributes="href item/absolute_url" tal:content="item/title">audio</a>
                <audio class="d-block mt-1 w-100" controls tal:attributes="src item/download_url"></audio>
              </li>
            </tal:repeat>
          </ul>
        </div>
      </div>

      <!-- Assistents -->
      <div class="tab-pane fade" id="assistents" role="tabpanel" aria-labelledby="assistents-tab">
        <!-- Sub-pestañas para la relación d'assistents -->
        <ul class="nav nav-pills mb-3" id="assistSubTabs" role="tablist">
          <li class="nav-item" tal:condition="membresConvocats" role="presentation">
            <button class="nav-link active" id="tab-assistents" data-bs-toggle="pill" data-bs-target="#pane-assistents" type="button" role="tab">Assistents</button>
          </li>
          <li class="nav-item" tal:condition="membresConvidats" role="presentation">
            <button class="nav-link" id="tab-convidats" data-bs-toggle="pill" data-bs-target="#pane-convidats" type="button" role="tab">Convidats</button>
          </li>
          <li class="nav-item" tal:condition="llistaExcusats" role="presentation">
            <button class="nav-link" id="tab-excusats" data-bs-toggle="pill" data-bs-target="#pane-excusats" type="button" role="tab">Excusats</button>
          </li>
          <li class="nav-item" tal:condition="llistaNoAssistens" role="presentation">
            <button class="nav-link" id="tab-noassist" data-bs-toggle="pill" data-bs-target="#pane-noassist" type="button" role="tab">No assistents</button>
          </li>
        </ul>

        <div class="tab-content border border-top-0 p-3" id="assistSubTabContent">
          <div class="tab-pane fade show active" id="pane-assistents" role="tabpanel" aria-labelledby="tab-assistents" tal:condition="membresConvocats">
            <span tal:replace="structure membresConvocats/output"/>
          </div>
          <div class="tab-pane fade" id="pane-convidats" role="tabpanel" aria-labelledby="tab-convidats" tal:condition="membresConvidats">
            <span tal:replace="structure membresConvidats/output"/>
          </div>
          <div class="tab-pane fade" id="pane-excusats" role="tabpanel" aria-labelledby="tab-excusats" tal:condition="llistaExcusats">
            <span tal:replace="structure llistaExcusats/output"/>
          </div>
          <div class="tab-pane fade" id="pane-noassist" role="tabpanel" aria-labelledby="tab-noassist" tal:condition="llistaNoAssistens">
            <span tal:replace="structure llistaNoAssistens/output"/>
          </div>
        </div>
      </div>
    </div>

    <!-- Ordre del dia -->
    <div class="mt-4" tal:condition="ordenDelDia" tal:content="structure ordenDelDia/output"></div>

    <!-- Annexes & Acta PDF -->
    <div class="mt-4" tal:condition="annexes">
      <h5 i18n:translate="">Fitxers adjunts</h5>
      <ul class="list-unstyled">
        <tal:repeat repeat="item annexes">
          <li>
            <i class="bi bi-paperclip"></i>
            <a tal:attributes="href item/absolute_url" tal:content="item/filename">annex</a>
            <span class="text-muted small ms-2">(<tal:replace="item/sizeKB"/> KB)</span>
            <a tal:attributes="href item/download_url" class="ms-1"><i class="bi bi-download"></i></a>
          </li>
        </tal:repeat>
      </ul>
    </div>

    <div class="mt-4" tal:condition="context/acta">
      <h5 i18n:translate="">Acta PDF</h5>
      <p>
        <i class="bi bi-file-earmark-pdf"></i>
        <a tal:attributes="href string:${absolute_url}/@@display-file/acta/; target string:_blank" tal:content="context/acta/filename">acta</a>
        <span class="text-muted small ms-2">(<tal:define="size context/acta/getSize; kb python:size//1024"><tal:replace="kb"/> KB)</span>
        <a tal:attributes="href string:${absolute_url}/@@download/acta/${context/acta/filename}" class="ms-1"><i class="bi bi-download"></i></a>
      </p>
    </div>

  </div> <!-- container -->

  <!-- Modal Previsualització Acta -->
  <div class="modal fade" id="previewActaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" i18n:translate="">Previsualització de l'acta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="previewActaBody">
          <!-- Contingut carregat via AJAX -->
        </div>
      </div>
    </div>
  </div>

  <script tal:attributes="type string:text/javascript">
  document.addEventListener('DOMContentLoaded', function () {
    var btn = document.getElementById('previewActaBtn');
    if (!btn) return;
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      var url = btn.getAttribute('data-url');
      fetch(url, {credentials: 'same-origin'})
        .then(function (r) { return r.text(); })
        .then(function (html) {
          var bodyEl = document.getElementById('previewActaBody');
          bodyEl.innerHTML = html;
          var modalEl = document.getElementById('previewActaModal');
          var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        });
    });
  });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var btn = document.getElementById('printActaBtn');
      var iframe = document.getElementById('printActaIframe');
      if (btn && iframe) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          // Cargar la URL de printActa en el iframe
          iframe.src = window.location.pathname + '/printActa';
          iframe.onload = function() {
            setTimeout(function() {
              iframe.contentWindow.focus();
              iframe.contentWindow.print();
            }, 200);
          };
        });
      }
    });
  </script>

</div>

</body>
</html>
