<html 
  xmlns="http://www.w3.org/1999/xhtml" 
  xml:lang="en" 
  xmlns:tal="http://xml.zope.org/namespaces/tal" 
  xmlns:metal="http://xml.zope.org/namespaces/metal" 
  xmlns:i18n="http://xml.zope.org/namespaces/i18n" 
  lang="ca" 
  metal:use-macro="context/main_template/macros/master" 
  i18n:domain="genweb.organs">
<body>
<metal:main fill-slot="main" tal:condition="view/canView">
<tal:main-macro metal:define-macro="main" 
                tal:define="items view/PuntsInside; 
                            canModify view/canModify; 
                            hihaDocs view/hihaDocs; 
                            getTitlePrompt view/getTitlePrompt; 
                            getErrorPrompt view/getErrorPrompt; 
                            acta view/activeActa; 
                            checkSerieGDoc view/checkSerieGDoc;">

  <div tal:replace="structure provider:plone.abovecontenttitle"></div>
  <h1 class="documentFirstHeading">Informacio de signatures i desat de documentació</h1>
  <div tal:replace="structure provider:plone.abovecontentbody"></div>
  <div tal:replace="structure provider:plone.belowcontentbody"></div>

  <div class="mb-3">
    <a class="btn btn-outline-primary" tal:attributes="href context/absolute_url">
      <i class="bi bi-chevron-left me-1" aria-hidden="true"></i> 
      <tal:omit-tag i18n:translate="">Tornar</tal:omit-tag>
    </a>
  </div>

  <div id="contentSessio">
    <ul id="tabs" class="nav nav-tabs mb-2" data-bs-toggle="tabs">
      <li class="nav-item" tal:condition="hihaDocs">
        <a class="nav-link active" href="#documentsTab" data-bs-toggle="tab">
          <i class="bi bi-list me-1" aria-hidden="True"></i> 
          <tal:omit-tag i18n:translate="">Documentació</tal:omit-tag>
        </a>
      </li>
      <li class="nav-item">
        <a tal:attributes="class python:'nav-link' if hihaDocs else 'nav-link active'" 
           href="#actaTab" data-bs-toggle="tab">
          <i class="bi bi-file-text-o me-1" aria-hidden="True"></i> 
          <tal:omit-tag i18n:translate="">Acta</tal:omit-tag>
        </a>
      </li>
    </ul>
    <div id="sesionTabs" class="tab-content" >

      <div id="documentsTab" class="tab-pane active" tal:condition="hihaDocs">
        <div tal:condition="items" id="documentsTab" class="dades overflow-hidden">
          <div class="card bg-body-secondary border-0 mb-3">
            <div class="card-body">
              <h4>Possibles estats dels fitxers</h4>
              <div class="legend-sign-item">
                <i class="bi bi-circle-fill me-1 estatFirmaFile text-success"></i>
                <span>El fitxer s'ha pujat i desat correctament a gDOC.</span>
              </div>
              <div class="legend-sign-item">
                <i class="bi bi-circle-fill me-1 estatFirmaFile text-warning"></i>
                <span>El fitxer, prèviament pujat i desat a gDOC, ha estat reemplaçat i s'ha d'enviar de nou.</span>
              </div>
              <div class="legend-sign-item">
                <i class="bi bi-circle-fill me-1 estatFirmaFile text-danger"></i>
                <span>No s'ha pogut enviar el fitxer a gDOC. Normalment, és un problema temporal i es resol al intentar pujar el fitxer de nou al cap d'una estona.</span>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-3">
            <div class="d-flex">
              <button id="expandAll" class="btn btn-outline-primary d-none">
                <i class="bi bi-arrows-expand me-1"></i>
                <span i18n:translate="">Desplega tot</span>
              </button>
              <button id="collapseAll" class="btn btn-outline-primary">
                <i class="bi bi-arrows-collapse me-1"></i>
                <span i18n:translate="">Plega tot</span>
              </button>
            </div>

            <tal:block tal:condition="view/canFirm">
              <button class="btn btn-primary btn-send-confirm float-end"
                      id="previewDocBtn"
                      tal:condition="checkSerieGDoc/valid_serie">
                <i class="bi bi-arrow-right me-1"></i>
                <span i18n:translate="">Signatura electrònica automatitzada</span>
              </button>
            </tal:block>
          </div>

          <ul class="list-unstyled">
            <tal:documents repeat="item items">
              <tal:block tal:define="agreement item/agreement">
                <li tal:attributes="id item/id">
                  <div class="row px-3 py-2 justify-content-end" tal:condition="item/show">
                    <tal:block-contenidos tal:define="files python:view.filesinsidePunt(item);
                                                      subpunts python:view.SubpuntsInside(item);
                                                      contenidos python:files or subpunts">

                      <div class="puntTitle col-12 d-flex flex-nowrap align-items-baseline">
                        <div class="fletxaSpan me-2 w-3">
                          <button type="button" class="btn px-0 py-0 btn-expand-collapse" 
                                  tal:condition="contenidos"
                                  data-bs-toggle="collapse"
                                  tal:attributes="data-bs-target string:#collapse-${item/id}"
                                  aria-expanded="false">
                            <i class="bi bi-chevron-down d-none"></i>
                            <i class="bi bi-chevron-up"></i>
                          </button>
                        </div>

                        <div class="numberSpan me-2 w-5 text-end">
                          <span class="proposalNumber text-primary fs-xxxl fw-bold"
                                tal:content="item/proposalPoint"></span>
                        </div>

                        <div class="titleSpan me-2 w-92">
                          <a tal:attributes="data-id item/id; 
                                            href item/absolute_url" 
                            data-url="changeTitle"
                            class="editTitle titleSize text-dark">
                            <tal:omit-tag tal:content="item/title">Item Title</tal:omit-tag>
                          </a>
                          <span tal:condition="agreement" class="text-muted fs-s"
                                tal:attributes="data-agreement string:${item/absolute_url}">
                            [<tal:omit-tag i18n:translate="">acord</tal:omit-tag> <tal:omit-tag
                                          tal:content="agreement">Acord code </tal:omit-tag>]
                          </span>
                        </div>

                      </div>
                      <div class="collapse multi-collapse-points show" 
                           tal:attributes="id string:collapse-${item/id}" 
                           tal:condition="contenidos">
                        <tal:files tal:condition="files">
                          <ul class="listFiles list-unstyled">
                            <tal:documents repeat="file_item files">
                              <li class="filesinTable w-100 mt-2">
                                <div class="titleSpan">
                                  <i tal:attributes="class string:${file_item/classCSS} me-1"></i>
                                  <a tal:attributes="href file_item/absolute_url;" 
                                    tal:condition="file_item/new_tab"
                                    target="_blank"
                                    class="text-dark">
                                    <tal:omit-tag tal:content="file_item/title"> Doc title</tal:omit-tag>
                                  </a>
                                  <a tal:attributes="href file_item/absolute_url;"
                                    tal:condition="not:file_item/new_tab"
                                    class="text-dark">
                                    <tal:omit-tag tal:content="file_item/title"> Doc title</tal:omit-tag>
                                  </a>
                                  <div class="float-end d-flex align-items-center">
                                    <span class="text-danger-emphasis"
                                          tal:condition="not:file_item/info_firma/success" 
                                          tal:content="file_item/info_firma/message"></span>
                                    <i title="Enviat i desat a gDOC"
                                        tal:condition="file_item/info_firma/sent"
                                        tal:attributes="class string:bi bi-circle-fill ${file_item/info_firma/cssClass} ms-1">
                                    </i>
                                    <tal:block tal:condition="view/canFirm">
                                      <input class="form-check-input mt-0 ms-1" type="checkbox" autocomplete="off"
                                              tal:condition="not:file_item/info_firma/success"
                                              tal:attributes="name python:'check:'+file_item['uuid']; value file_item/uuid" 
                                              checked="checked" />
                                    </tal:block>
                                  </div>
                                </div>
                              </li>
                            </tal:documents>
                          </ul>
                        </tal:files>
                        <div tal:condition="subpunts">
                          <tal:subpunts repeat="itemSubpunt subpunts">
                            <div class="li_subgrups row mt-2 justify-content-end" 
                                 tal:attributes="id itemSubpunt/id" 
                                 tal:define="agreement itemSubpunt/agreement;
                                             itemSubpunt_id itemSubpunt/id;">

                              <div class="subpuntTitle col-12 d-flex flex-nowrap align-items-baseline">
                                <div class="numberSpan me-2 w-5">
                                  <span class="proposalNumberSubpunt text-primary fw-bold" 
                                        tal:content="itemSubpunt/proposalPoint"></span>
                                </div>

                                <div class="titleSpan me-2 w-95">
                                  <a tal:attributes="data-id itemSubpunt_id; 
                                                     href itemSubpunt/absolute_url"
                                    data-type="text" data-url="changeTitle" 
                                    class="editTitle subtitleSize text-dark">
                                    <tal:omit-tag tal:content="itemSubpunt/title">Item Title</tal:omit-tag>
                                  </a>
                                  <span tal:condition="agreement" class="text-muted fs-s"
                                        tal:attributes="data-agreement string:${itemSubpunt/absolute_url}">
                                    [<tal:omit-tag i18n:translate="">acord</tal:omit-tag> <tal:omit-tag
                                      tal:content="agreement">Acord code </tal:omit-tag>]
                                  </span>
                                </div>

                              </div>
                              <tal:files tal:define="files python:view.filesinsidePunt(itemSubpunt)">
                                <ul class="listFiles list-unstyled" tal:condition="files">
                                  <tal:documents repeat="item files">
                                    <li class="filesinTable w-100 mt-2">
                                      <i tal:attributes="class string:${item/classCSS} me-1"></i>
                                      <a tal:attributes="href item/absolute_url;" 
                                          tal:condition="item/new_tab"
                                          target="_blank"
                                          class="text-dark">
                                        <tal:omit-tag tal:content="item/title"> Doc title</tal:omit-tag>
                                      </a>
                                      <a tal:attributes="href item/absolute_url;" 
                                          tal:condition="not:item/new_tab"
                                          class="text-dark">
                                        <tal:omit-tag tal:content="item/title"> Doc title</tal:omit-tag>
                                      </a>
                                      <div class="float-end d-flex align-items-center">
                                        <span class="text-danger-emphasis"
                                              tal:condition="not:item/info_firma/success" 
                                              tal:content="item/info_firma/message"></span>
                                        <i title="Enviat i desat a gDOC"
                                          tal:condition="item/info_firma/sent"
                                          tal:attributes="class string:bi bi-circle-fill ${item/info_firma/cssClass} ms-1">
                                        </i>
                                        <tal:block tal:condition="view/canFirm">
                                          <input class="form-check-input mt-0 ms-1" type="checkbox" autocomplete="off"
                                                tal:condition="not:item/info_firma/success"
                                                tal:attributes="name python:'check:'+item['uuid']; value item/uuid" 
                                                checked="checked" />
                                        </tal:block>
                                      </div>
                                    </li>
                                  </tal:documents>
                                </ul>
                              </tal:files>
                            </div>
                          </tal:subpunts>
                        </div>
                      </div>
                    </tal:block-contenidos>
                  </div>
                </li>
              </tal:block>
            </tal:documents>
          </ul>
          <input tal:replace="structure context/@@authenticator/authenticator" />
        </div>
      </div>

      <div id="actaTab" tal:attributes="class python: 'tab-pane' + ('' if hihaDocs else ' active')" tal:condition="acta">
        <div tal:define="ordenDelDia acta/ordenDelDia;
                         audio python:view.AudioInsideActa(acta);
                         annexes python:view.AnnexInsideActa(acta);
                         enllacVideo acta/enllacVideo;
                         absolute_url acta/absolute_url;
                         hasFirma python:view.hasFirma(acta);">

          <div class="d-flex justify-content-end mb-3">
                          
            <tal:block tal:condition="hasFirma">

              <span tal:define="estatFirma python:view.estatFirma(acta)"
                    tal:attributes="class string:badge rounded-pill estatFirma ${estatFirma/class}">
                <tal:block i18n:translate="">Acta: </tal:block>
                <tal:block tal:content="estatFirma/text">PENDENT_SIGNANTS</tal:block>
              </span>

            </tal:block>

            <tal:block tal:condition="view/canFirm">

              <a id="previewActaBtn" class="btn btn-outline-secondary me-3" 
                 tal:attributes="data-url string:${absolute_url}/previewActa" 
                 href="#">
                <i class="bi bi-eye"></i> <span i18n:translate="">Previsualitza</span>
              </a>

              <tal:block tal:condition="not:hasFirma">
                <button id="signActa" class="btn btn-primary btnActa"
                  tal:condition="checkSerieGDoc/valid_serie"
                  tal:attributes="data-sign-url string:${acta/absolute_url}/signActa">
                    <i class="bi bi-arrow-right"></i>&nbsp;<span i18n:translate="">Enviar acta a signar</span>
                </button>
              </tal:block>

            </tal:block>

          </div>

          <tal:block tal:condition="ordenDelDia">
            <div tal:content="structure ordenDelDia/output"></div>
          </tal:block>

          <br/>

          <tal:block tal:condition="not:hasFirma">
            <tal:block tal:condition="annexes">
              <tal:block tal:define="multiple_annexes python:len(annexes)>1">
                <h3 class="mb-2" tal:condition="multiple_annexes" i18n:translate="">Fitxers adjunts</h3>
                <h3 class="mb-2" tal:condition="not:multiple_annexes" i18n:translate="">Fitxer adjunt</h3>
              </tal:block>
              <tal:documents repeat="item annexes">
                <div tal:define="public_file_download_url string:${item/absolute_url}/@@download/file/${item/filename};
                                public_file_view_url string:${item/absolute_url}/@@display-file/file/;">
                  <p>
                    <a tal:attributes="href public_file_view_url">
                      <i class="bi bi-file-pdf-o" aria-hidden="true"></i>
                      <tal:name tal:content="item/filename">Filename</tal:name>
                    </a>
                    <span class="discreet">
                      &mdash; <span tal:replace="item/sizeKB" /> KB</span>
                      <a tal:attributes="href public_file_download_url">
                        <i class="bi bi-download" aria-hidden="true"></i>
                      </a>
                  </p>
                </div>
              </tal:documents>
            </tal:block>

            <tal:block tal:condition="acta/acta">
              <div tal:define="public_acta_download_url string:${absolute_url}/@@download/acta/${acta/acta/filename};
                              public_acta_view_url string:${absolute_url}/@@display-file/acta/;
                              isSigned python:view.isSigned(acta)">
                <h3 class="mb-2" tal:condition="not:isSigned" i18n:translate="">Acta PDF</h3>
                <h3 class="mb-2" tal:condition="isSigned" i18n:translate="">Acta signada</h3>
                <p>
                  <a tal:attributes="href public_acta_view_url">
                    <i class="bi bi-file-pdf-o" aria-hidden="true"></i>
                    <tal:name tal:content="acta/acta/filename">Filename</tal:name>
                  </a>
                  <span class="discreet"
                        tal:define="size acta/acta/getSize;
                                    kb python:size/1024">
                    &mdash; <span tal:replace="acta/acta/getSize" /> KB</span>
                    <a tal:attributes="href public_acta_download_url">
                      <i class="bi bi-download" aria-hidden="true"></i>
                    </a>
                </p>
              </div>
            </tal:block>
          </tal:block>

          <tal:block tal:condition="hasFirma" tal:define="actaPDF python:view.getPDFActa(acta)">
            <tal:block tal:condition="annexes">
              <tal:block tal:define="multiple_annexes python:len(annexes)>1">
                <h3 class="mb-2" tal:condition="multiple_annexes" i18n:translate="">Fitxers adjunts</h3>
                <h3 class="mb-2" tal:condition="not:multiple_annexes" i18n:translate="">Fitxer adjunt</h3>
              </tal:block>
              <tal:documents repeat="item annexes">
                <div tal:define="public_file_download_url item/download_url;
                                 public_file_view_url item/absolute_url">
                  <p>
                    <a tal:attributes="href public_file_view_url">
                      <i class="bi bi-file-pdf-o" aria-hidden="true"></i>
                      <tal:name tal:content="item/filename">Filename</tal:name>
                    </a>
                    <span class="discreet">
                      &mdash; <span tal:replace="item/sizeKB" /> KB</span>
                      <a tal:attributes="href public_file_download_url">
                        <i class="bi bi-download" aria-hidden="true"></i>
                      </a>
                  </p>
                </div>
              </tal:documents>
            </tal:block>

            <div tal:define="public_acta_download_url string:${absolute_url}/downloadActa;
                            public_acta_view_url string:${absolute_url}/viewActa;
                            isSigned python:view.isSigned(acta)">
              <h3 class="mb-2" tal:condition="not:isSigned" i18n:translate="">Acta PDF</h3>
              <h3 class="mb-2" tal:condition="isSigned" i18n:translate="">Acta signada</h3>
              <p>
                <a tal:attributes="href public_acta_view_url">
                  <i class="bi bi-file-pdf-o" aria-hidden="true"></i>
                  <tal:name tal:content="actaPDF/filename">Filename</tal:name>
                </a>
                <span class="discreet"
                    tal:define="kb actaPDF/sizeKB">
                  &mdash; <span tal:replace="kb" /> KB</span>
                  <a tal:attributes="href public_acta_download_url">
                    <i class="bi bi-download" aria-hidden="true"></i>
                  </a>
              </p>
            </div>
          </tal:block>
        </div>
      </div>

      <div id="actaTab" tal:attributes="class python: 'tab-pane' + ('' if hihaDocs else ' active')" tal:condition="not:acta">
        <div class="alert alert-warning" role="alert">
          <strong i18n:translate="">Alerta</strong>
          <span i18n:translate="">Encara no s'ha generat cap acta per signar.</span>
          <a class="alert-link" tal:attributes="href python:context.absolute_url() + '/++add++genweb.organs.acta/'">
            <span i18n:translate="">Afegeix un acta</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="spinner-block position-fixed top-0 start-0 vw-100 vh-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-25 d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Modal Previsualització Acta -->
  <div class="modal fade" id="previewActaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" i18n:translate="">Previsualització de l'acta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="previewActaBody">
          <!-- Contingut carregat via AJAX -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Previsualització Documentacio -->
  <div class="modal fade" id="previewDocModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" i18n:translate="">Aquests documents s'enviaran al Gestor Documental</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="previewActaBody">
          <ul class="list-unstyled">
            <tal:documents repeat="item items">
              <tal:block tal:define="agreement item/agreement">
                <li tal:attributes="id item/id">
                  <div class="row px-3 py-2" tal:condition="item/show">
                    <tal:block-contenidos tal:condition="python: view.hasUnsentFiles(item, depth=2)"
                                          tal:define="files python:view.filesinsidePunt(item);
                                                      subpunts python:view.SubpuntsInside(item);">

                      <div class="puntTitle col-12 d-flex flex-nowrap align-items-baseline">
                        <div class="numberSpan me-2 w-5 text-end">
                          <span class="proposalNumber text-primary fs-xxxl fw-bold"
                                tal:content="item/proposalPoint"></span>
                        </div>

                        <div class="titleSpan me-2 w-75">
                          <a tal:attributes="data-id item/id; 
                                            href item/absolute_url" 
                            data-url="changeTitle"
                            class="editTitle titleSize text-dark">
                            <tal:omit-tag tal:content="item/title">Item Title</tal:omit-tag>
                          </a>
                          <span tal:condition="agreement" class="text-muted fs-s"
                                tal:attributes="data-agreement string:${item/absolute_url}">
                            [<tal:omit-tag i18n:translate="">acord</tal:omit-tag> <tal:omit-tag
                                          tal:content="agreement">Acord code </tal:omit-tag>]
                          </span>
                        </div>
                      </div>

                      <tal:files tal:condition="files">
                        <ul class="listFiles list-unstyled">
                          <tal:documents repeat="file_item files">
                            <li class="filesinTable w-100 mt-2"
                                tal:attributes="id file_item/uuid"
                                tal:condition="not:file_item/info_firma/success">
                              <div class="titleSpan">
                                <i tal:attributes="class string:${file_item/classCSS} me-1"></i>
                                <tal:omit-tag tal:content="file_item/title"> Doc title</tal:omit-tag>
                              </div>
                            </li>
                          </tal:documents>
                        </ul>
                      </tal:files>

                      <div class="container-subpunts" tal:condition="subpunts">
                        <tal:subpunts repeat="itemSubpunt subpunts">
                          <div class="li_subgrups row mt-2 justify-content-end" 
                              tal:condition="python:view.hasUnsentFiles(itemSubpunt)"
                              tal:attributes="id itemSubpunt/id" 
                              tal:define="agreement itemSubpunt/agreement;
                                          itemSubpunt_id itemSubpunt/id;">

                            <div class="subpuntTitle col-12 d-flex flex-nowrap align-items-baseline">
                              <div class="numberSpan me-2 w-5">
                                <span class="proposalNumberSubpunt text-primary fw-bold" 
                                      tal:content="itemSubpunt/proposalPoint"></span>
                              </div>

                              <div class="titleSpan me-2 w-95">
                                <a tal:attributes="data-id itemSubpunt_id; 
                                                  href itemSubpunt/absolute_url"
                                  data-type="text" data-url="changeTitle" 
                                  class="editTitle subtitleSize text-dark">
                                  <tal:omit-tag tal:content="itemSubpunt/title">Item Title</tal:omit-tag>
                                </a>
                                <span tal:condition="agreement" class="text-muted fs-s"
                                      tal:attributes="data-agreement string:${itemSubpunt/absolute_url}">
                                  [<tal:omit-tag i18n:translate="">acord</tal:omit-tag> <tal:omit-tag
                                    tal:content="agreement">Acord code </tal:omit-tag>]
                                </span>
                              </div>
                            </div>

                            <tal:files tal:define="files python:view.filesinsidePunt(itemSubpunt)">
                              <ul class="listFiles list-unstyled" tal:condition="files">
                                <tal:documents repeat="item files">
                                  <li class="filesinTable w-100 mt-2"
                                      tal:attributes="id item/uuid"
                                      tal:condition="not:item/info_firma/success">
                                    <i tal:attributes="class string:${item/classCSS} me-1"></i>
                                    <tal:omit-tag tal:content="item/title"> Doc title</tal:omit-tag>
                                  </li>
                                </tal:documents>
                              </ul>
                            </tal:files>
                          </div>
                        </tal:subpunts>
                      </div>
                    </tal:block-contenidos>
                  </div>
                </li>
              </tal:block>
            </tal:documents>
          </ul>
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-secondary" data-bs-dismiss="modal">Cancel·lar</a>
          <div id="send-sign-btn" class="btn btn-primary">Confirmar</div>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript"
          src="++theme++genweb.organs/js/content/sessio.min.js"></script>    

  <script type="text/javascript"
          src="++theme++genweb.organs/js/content/acta.min.js"></script>    

  <script type="text/javascript"
          src="++theme++genweb.organs/js/content/sign_sessio.min.js"></script>    

</tal:main-macro>
</metal:main>
</body>
</html>